# ã€Šå…«æ–¹æ—…äººã€‹é£æ ¼ Break ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## 1. æ ¸å¿ƒç†å¿µ
å¼•å…¥â€œéœ¸ä½“â€æœºåˆ¶ï¼Œå¼ºåŒ– BOSS æˆ˜çš„ç­–ç•¥æ€§ã€‚ç©å®¶å¿…é¡»å…ˆé€šè¿‡ç‰¹å®šæ‰‹æ®µï¼ˆæ™®æ”»æˆ–ç ´ç›¾æŠ€èƒ½ï¼‰å°† BOSS çš„æŠ¤ç›¾å±‚æ•°å‰Šå‡è‡³ 0ï¼Œè§¦å‘ **BREAK** çŠ¶æ€ï¼Œæ‰èƒ½å¯¹å…¶è¿›è¡Œæœ‰æ•ˆæ§åˆ¶ï¼ˆçœ©æ™•ï¼‰å’Œé«˜é¢è¾“å‡ºã€‚

## 2. æœºåˆ¶è¯¦è§£

### 2.1 éœ¸ä½“çŠ¶æ€ (Iron Body)
*   **è§¦å‘æ¡ä»¶**ï¼šç›®æ ‡çš„å½“å‰æŠ¤ç›¾å€¼ `currentShield > 0`ã€‚
*   **æ•ˆæœ**ï¼š
    *   **å…ç–«çœ©æ™•**ï¼šä»»ä½•æ¥æºçš„çœ©æ™•ï¼ˆStunï¼‰æ•ˆæœéƒ½ä¼šæ— æ•ˆåŒ–ã€‚
    *   **é«˜é˜²å¾¡**ï¼šç»´æŒåŸæœ‰çš„é«˜é˜²å¾¡åŠ›ï¼ˆå½“å‰ä»£ç å·²å®ç°ï¼‰ã€‚
    *   **åé¦ˆ**ï¼šå½“å°è¯•å¯¹éœ¸ä½“å•ä½æ–½åŠ çœ©æ™•æ—¶ï¼Œæˆ˜æ–—æ—¥å¿—æˆ–é£˜å­—æ˜¾ç¤º **â€œğŸ›¡ï¸ éœ¸ä½“å…ç–«ï¼â€**ã€‚

### 2.2 ç ´ç›¾ç¬é—´ (BREAK!)
*   **è§¦å‘æ¡ä»¶**ï¼šç›®æ ‡çš„å½“å‰æŠ¤ç›¾å€¼ä» `> 0` å˜ä¸º `0` çš„é‚£ä¸€ç¬é—´ã€‚
*   **æ•ˆæœ**ï¼š
    *   **å¼ºåˆ¶çœ©æ™•**ï¼šæ— è§†æŠ—æ€§ï¼Œå¼ºåˆ¶ä½¿ç›®æ ‡çœ©æ™• 1 å›åˆï¼ˆå¤±å»è¡ŒåŠ¨æœºä¼šï¼‰ã€‚
    *   **é˜²å¾¡å´©æºƒ**ï¼šé˜²å¾¡åŠ›ï¼ˆDEFï¼‰é™ä¸º 0ï¼ˆå½“å‰ä»£ç å·²å®ç°ï¼‰ã€‚
    *   **æ˜“ä¼¤çŠ¶æ€**ï¼šå—åˆ°çš„ä¼¤å®³ä¸å†è¢«æŠ¤ç›¾å‡å…ï¼ˆå½“å‰ä»£ç å·²å®ç°ï¼‰ã€‚
    *   **åé¦ˆ**ï¼šæ˜¾ç¤º **â€œğŸ’¥ BREAK! æŠ¤ç›¾ç ´ç¢ï¼â€**ã€‚

### 2.3 æŠ¤ç›¾æ¢å¤
*   **è§¦å‘æ¡ä»¶**ï¼šBOSS è¡ŒåŠ¨å›åˆå¼€å§‹æ—¶ï¼Œå¦‚æœå¤„äº Break çŠ¶æ€ï¼ˆshieldBroken = trueï¼‰ã€‚
*   **æ•ˆæœ**ï¼šæŠ¤ç›¾æ¢å¤è‡³æ»¡å€¼ï¼Œé˜²å¾¡åŠ›æ¢å¤ï¼Œè§£é™¤ Break çŠ¶æ€ï¼ˆå½“å‰ä»£ç å·²å®ç°ï¼‰ã€‚

## 3. è¯¦ç»†äº¤äº’æµç¨‹

```mermaid
graph TD
    A[ç©å®¶/å¬å”¤ç‰© å‘èµ·æ”»å‡»] --> B{é€ æˆä¼¤å®³?}
    B -- Yes --> C[æ‰£é™¤ HP]
    B -- No --> End
    
    A --> D{æ”»å‡»ç±»å‹}
    D -- æ™®æ”»/ç ´ç›¾æŠ€èƒ½ --> E[æ‰£é™¤æŠ¤ç›¾å±‚æ•°]
    D -- å…¶ä»–æŠ€èƒ½ --> F[ä¸æ‰£æŠ¤ç›¾]
    
    E --> G{æŠ¤ç›¾å½’é›¶?}
    G -- Yes (BREAK!) --> H[è®¾ç½® shieldBroken=true]
    H --> I[é˜²å¾¡å½’é›¶]
    H --> J[å¼ºåˆ¶çœ©æ™• 1 å›åˆ]
    H --> K[æ˜¾ç¤º: BREAK!]
    
    G -- No (æŠ¤ç›¾ä» > 0) --> L[ä¿æŒéœ¸ä½“çŠ¶æ€]
    
    A --> M{æŠ€èƒ½é™„å¸¦çœ©æ™•?}
    M -- Yes --> N{ç›®æ ‡çŠ¶æ€}
    N -- æŠ¤ç›¾ > 0 (éœ¸ä½“) --> O[å…ç–«çœ©æ™•]
    O --> P[æ˜¾ç¤º: éœ¸ä½“å…ç–«!]
    N -- æŠ¤ç›¾ = 0 (å·²Break) --> Q[æ–½åŠ çœ©æ™•]
```

## 4. å—å½±å“çš„æŠ€èƒ½ä¸æ•ˆæœ
ä»¥ä¸‹æƒ…å†µåœ¨ BOSS **æœ‰æŠ¤ç›¾** æ—¶å°†æ— æ³•è§¦å‘çœ©æ™•ï¼š

1.  **ä¸»åŠ¨æŠ€èƒ½çœ©æ™•**ï¼šå¦‚å¾·å…‹è¨æ–¯çš„ã€Šçœ©æ™•ã€‹æŠ€èƒ½ã€‚
2.  **æ¦‚ç‡è¢«åŠ¨çœ©æ™•**ï¼šå¦‚è¿·è¿­é¦™çš„æ”»å‡»/ä½™éœ‡é™„å¸¦æ¦‚ç‡çœ©æ™•ã€‚
3.  **å¬å”¤ç‰©ç‰¹æ€§**ï¼šå¦‚å¬å”¤ç‰©æ”»å‡»é™„å¸¦çœ©æ™•ï¼ˆstunOnHitï¼‰ã€‚
4.  **è£…å¤‡/è¯ç¼€æ•ˆæœ**ï¼šå¦‚æœæœªæ¥æœ‰â€œæ”»å‡»æ¦‚ç‡çœ©æ™•â€çš„è£…å¤‡ã€‚

## 5. ä»£ç ä¿®æ”¹è®¡åˆ’ (js/skillEffects.js)

éœ€è¦ä¿®æ”¹ä»¥ä¸‹å‡½æ•°ï¼Œæ¤å…¥â€œéœ¸ä½“æ£€æµ‹â€é€»è¾‘ï¼š

1.  **`executeStunEffect`** (ä¸»åŠ¨çœ©æ™•):
    *   å¢åŠ æ£€æŸ¥ï¼š`if (target.currentShield > 0 && !target.shieldBroken)` -> `return` å¹¶æç¤ºå…ç–«ã€‚

2.  **`executeDamageEffect`** (ä¼¤å®³é™„å¸¦çœ©æ™•):
    *   åœ¨å¤„ç† `stunChance` é€»è¾‘å‰ï¼Œå¢åŠ éœ¸ä½“æ£€æŸ¥ã€‚
    *   åœ¨å¤„ç† `stunOnHit` (å¬å”¤ç‰©) é€»è¾‘å‰ï¼Œå¢åŠ éœ¸ä½“æ£€æŸ¥ã€‚

3.  **`executeAftershockEffect`** (è¿·è¿­é¦™ä½™éœ‡):
    *   åœ¨å¤„ç†ä½™éœ‡çœ©æ™•é€»è¾‘å‰ï¼Œå¢åŠ éœ¸ä½“æ£€æŸ¥ã€‚

4.  **`executeShieldBreakEffect`** (ç ´ç›¾æŠ€èƒ½):
    *   **æ³¨æ„**ï¼šæ­¤å‡½æ•°ä¼šå¯¼è‡´æŠ¤ç›¾å½’é›¶ã€‚é€»è¾‘å¿…é¡»ç¡®ä¿åœ¨æŠ¤ç›¾å½’é›¶çš„**å½“æ¬¡**å¤„ç†ä¸­ï¼Œçœ©æ™•èƒ½å¤Ÿç”Ÿæ•ˆï¼ˆå› ä¸ºè¿™æ˜¯ Break çš„å¥–åŠ±ï¼‰ï¼Œä½†å¦‚æœæŠ¤ç›¾æœªå½’é›¶ï¼Œåˆ™ä¸èƒ½ç”±å…¶ä»–é™„å¸¦æ•ˆæœå¯¼è‡´çœ©æ™•ã€‚

## 6. å¾…ç¡®è®¤äº‹é¡¹
*   **å‡»é€€æ•ˆæœ**ï¼šç›®å‰æ¸¸æˆä¸­ä¼¼ä¹è¿˜æ²¡æœ‰â€œå‡»é€€è¡ŒåŠ¨æ¡â€çš„æŠ€èƒ½ã€‚å¦‚æœæœ‰ï¼Œæ˜¯å¦ä¹Ÿè¦å…ç–«ï¼Ÿï¼ˆå»ºè®®ï¼šé€šå¸¸ Break ç³»ç»Ÿä¹Ÿå…ç–«å‡»é€€ï¼Œæˆ–è€…å‡»é€€æ•ˆæœå‡åŠã€‚ç›®å‰æš‚æ— æ­¤æœºåˆ¶ï¼Œå¯æš‚ä¸è€ƒè™‘ã€‚ï¼‰
*   **å¼ºåˆ¶å‰§æƒ…æ€**ï¼šæ˜¯å¦æœ‰å‰§æƒ…å¼ºåˆ¶çœ©æ™•çš„éœ€æ±‚ï¼Ÿï¼ˆå¦‚æœæœ‰ï¼Œéœ€è¦åŠ ä¸€ä¸ª `ignoreImmunity` æ ‡å¿—ï¼‰ã€‚

---

## 7. ä¼¤å®³ç±»å‹ä¸äº¤äº’è§„åˆ™ (è¡¥å…… v2.0)

æˆ‘ä»¬å°†å¼•å…¥ `DMG_SOURCE` æšä¸¾æ¥ç²¾ç»†æ§åˆ¶ç ´ç›¾å’Œåä¼¤çš„äº¤äº’é€»è¾‘ã€‚

### 7.1 ä¼¤å®³æ¥æºåˆ†ç±»

| æ¥æºç±»å‹ | ä»£ç å¸¸é‡ | å…¸å‹ä¾‹å­ | ç ´ç›¾èƒ½åŠ› (Break) | è§¦å‘åä¼¤ (Reflect) |
| :--- | :--- | :--- | :---: | :---: |
| **ç›´æ¥æ”»å‡»** | `DIRECT` | æ™®æ”»ã€å•ä½“æŠ€èƒ½ã€AOEæŠ€èƒ½ | âœ… æ˜¯ | âœ… æ˜¯ |
| **ç¯å¢ƒä¼¤å®³** | `ENVIRONMENT` | ä½™éœ‡ (è¿·è¿­é¦™)ã€æº…å°„ (ç‚¹ç‡ƒ)ã€å†²å‡»æ³¢ | âœ… æ˜¯ | âŒ **å¦** |
| **æŒç»­ä¼¤å®³** | `DOT` | æ¯’ã€ç¼çƒ§ã€æµè¡€ | âŒ å¦ | âŒ å¦ |

### 7.2 é€»è¾‘ä¼ªä»£ç 

```javascript
// å®šä¹‰ä¼¤å®³ç±»å‹æšä¸¾ (js/skillCore.js)
export const DMG_SOURCE = {
    DIRECT: 'direct',       // ç›´æ¥æ”»å‡»
    ENVIRONMENT: 'env',     // ç¯å¢ƒ/ä½™éœ‡
    DOT: 'dot'              // æŒç»­ä¼¤å®³
};

/**
 * ç»ˆæç‰ˆä¼¤å®³å¤„ç†å‡½æ•°é€»è¾‘ (executeDamageEffect)
 */
function applyDamage(attacker, defender, damage, sourceType = DMG_SOURCE.DIRECT) {
    
    // 1. ç ´ç›¾åˆ¤å®š (Break System)
    // ç›´æ¥æ”»å‡»å’Œç¯å¢ƒå†²å‡»éƒ½èƒ½å‰Šå‡æŠ¤ç›¾
    if (defender.shield > 0) {
        if (sourceType === DMG_SOURCE.DIRECT || sourceType === DMG_SOURCE.ENVIRONMENT) {
            defender.shield = Math.max(0, defender.shield - 1);
            console.log(`ğŸ”¨ [BREAK] æŠ¤ç›¾ -1 (å‰©ä½™ ${defender.shield})`);
            
            if (defender.shield === 0) triggerBreak(defender);
        }
        // æœªç ´ç›¾æ—¶çš„å‡ä¼¤é€»è¾‘ (ä¿æŒåŸæœ‰é€»è¾‘)
        // damage = Math.floor(damage * 0.3); // ç¤ºä¾‹
    }

    // 2. æ‰£è¡€
    defender.hp -= damage;

    // 3. åä¼¤åˆ¤å®š (Reflect System)
    // åªæœ‰ [ç›´æ¥æ”»å‡»] æ‰ä¼šè§¦å‘åä¼¤
    if (sourceType === DMG_SOURCE.DIRECT && hasAffix(defender, 'reflect')) {
        doReflect(attacker, defender, damage);
    } else if (sourceType === DMG_SOURCE.ENVIRONMENT) {
        console.log(`ğŸŒŠ [SAFE] ä½™éœ‡å†²å‡»æ³¢é€ æˆä¼¤å®³ï¼Œæœªè§¦å‘åä¼¤ï¼`);
    }
}
```

### 7.3 æ›´æ–°è®¡åˆ’
*   åœ¨ `js/skillCore.js` ä¸­å®šä¹‰å¹¶å¯¼å‡º `DMG_SOURCE`ã€‚
*   é‡æ„ `js/skillEffects.js` ä¸­çš„ `executeDamageEffect`ï¼Œå¢åŠ  `sourceType` å‚æ•°å¹¶å®ç°ä¸Šè¿°é€»è¾‘ã€‚
*   æ›´æ–° `executeAftershockEffect` å’Œ `executeSplashDamage`ï¼Œè°ƒç”¨ä¼¤å®³å‡½æ•°æ—¶ä¼ å…¥ `DMG_SOURCE.ENVIRONMENT`ã€‚
